<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhyming Pairs — Admin</title>
  <style>
    :root {
      --bg:#0a1a12;
      --fg:#eef8f1;
      --muted:#b9d7c5;
      --accent:#7de0a2;
      --ok:#62d38a;
      --bad:#ff8f8f;
      --panel:#10261c;
      --border:#1f3a2a;
      --field:#0e2118;
      --button:#173726;
    }
    html,body { margin:0; height:100%; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--fg); }
    .wrap { max-width:900px; margin:0 auto; padding:24px; }
    h1 { font-size:1.25rem; margin:0 0 12px; color:var(--fg); }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; margin-top:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:560px){ .row{ grid-template-columns:1fr; } }
    label { display:block; font-size:.9rem; color:var(--muted); margin-bottom:6px; }
    input, textarea { width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--field); color:var(--fg); }
    textarea { min-height:120px; resize:vertical; }
    .answer-row { grid-template-columns:repeat(auto-fit, minmax(140px, 220px)); justify-content:flex-start; }
    .answer-row input { max-width:220px; }
    .preview { margin-top:10px; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#0c1d14; min-height:140px; display:flex; align-items:center; justify-content:center; }
    .preview img { max-width:100%; max-height:220px; display:block; }
    .calendar { display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; margin-top:12px; }
    .calendar-day { padding:10px; border-radius:10px; border:1px solid var(--border); text-align:center; background:#123323; cursor:pointer; user-select:none; }
    .calendar-day.is-empty { color:var(--muted); background:var(--field); }
    .calendar-day.is-scheduled { background:#204233; border-color:#2f5a43; color:#dff6e8; font-weight:600; }
    .calendar-day.is-today { outline:2px solid var(--accent); }
    .calendar-day.is-selected { box-shadow:0 0 0 2px rgba(125,224,162,0.45); }
    .calendar-header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .calendar-header button { padding:6px 10px; }
    .calendar-weekday { text-align:center; font-size:.8rem; color:var(--muted); }
    .legend { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
    .legend span { display:inline-flex; align-items:center; gap:6px; }
    .legend i { width:12px; height:12px; border-radius:4px; display:inline-block; }
    .legend .legend-scheduled { background:#204233; border:1px solid #2f5a43; }
    .legend .legend-empty { background:var(--field); border:1px solid var(--border); }
    button { padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--button); color:var(--fg); cursor:pointer; }
    button:hover { filter:brightness(1.1); }
    .status { margin-top:10px; font-weight:600; }
    .status.ok { color:var(--ok); }
    .status.bad { color:var(--bad); }
    .small { color:var(--muted); font-size:.9rem; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .calendar-actions { margin-top:12px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>Rhyming Pairs Admin</h1>

    <div class="card" id="authCard">
      <p class="small">Use a magic link to sign in. You only need your email.</p>
      <div class="row">
        <div>
          <label for="email">Admin email</label>
          <input id="email" type="email" placeholder="you@example.com" />
        </div>
        <div class="actions" style="align-items:flex-end;">
          <button id="sendLinkBtn" type="button">Send Magic Link</button>
        </div>
      </div>
      <div id="authStatus" class="status"></div>
    </div>

    <div class="card" id="uploadCard" style="display:none;">
      <h2>Upload a puzzle</h2>
      <div class="row">
        <div>
          <label for="image">Puzzle image</label>
          <input id="image" type="file" accept="image/*" />
          <div class="preview" aria-live="polite">
            <img id="imagePreview" alt="Selected puzzle preview" />
          </div>
        </div>
        <div>
          <label for="publishAt">Publish date (UTC)</label>
          <input id="publishAt" type="date" />
        </div>
      </div>

      <div class="row answer-row" style="margin-top:12px;">
        <div>
          <label for="answer1a">Answer 1 — word A</label>
          <input id="answer1a" type="text" placeholder="cracked" />
        </div>
        <div>
          <label for="answer1b">Answer 1 — word B</label>
          <input id="answer1b" type="text" placeholder="stones" />
        </div>
      </div>
      <div class="row answer-row" style="margin-top:12px;">
        <div>
          <label for="answer2a">Answer 2 — word A</label>
          <input id="answer2a" type="text" placeholder="stacked" />
        </div>
        <div>
          <label for="answer2b">Answer 2 — word B</label>
          <input id="answer2b" type="text" placeholder="crones" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <label for="hints">Hints (one per line)</label>
        <textarea id="hints" placeholder="Hint 1&#10;Hint 2"></textarea>
      </div>

      <div class="actions">
        <button id="uploadBtn" type="button">Upload Puzzle</button>
        <button id="logoutBtn" type="button">Log out</button>
      </div>
      <div id="uploadStatus" class="status"></div>
    </div>

    <div class="card" id="scheduleCard" style="display:none;">
      <div class="calendar-header">
        <h2 style="margin:0;">Puzzle calendar</h2>
        <div class="actions" style="margin-top:0;">
          <button id="prevMonthBtn" type="button" aria-label="Previous month">Prev</button>
          <button id="nextMonthBtn" type="button" aria-label="Next month">Next</button>
        </div>
      </div>
      <div id="calendarLabel" class="small" style="margin-top:6px;"></div>
      <div class="calendar" id="calendarGrid"></div>
      <div class="legend small">
        <span><i class="legend-scheduled"></i>Scheduled</span>
        <span><i class="legend-empty"></i>Open</span>
      </div>
      <div class="calendar-actions">
        <div id="selectedDateLabel" class="small">Select a date to set a publish date or manage scheduled puzzles.</div>
        <div id="scheduledActions" class="actions" style="display:none;">
          <button id="replaceBtn" type="button">Replace puzzle</button>
          <button id="removeBtn" type="button">Remove puzzle</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const authStatus = document.getElementById("authStatus");
    const uploadStatus = document.getElementById("uploadStatus");
    const uploadCard = document.getElementById("uploadCard");
    const scheduleCard = document.getElementById("scheduleCard");
    const sendLinkBtn = document.getElementById("sendLinkBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const imageInput = document.getElementById("image");
    const imagePreview = document.getElementById("imagePreview");
    const publishAtInput = document.getElementById("publishAt");
    const calendarGrid = document.getElementById("calendarGrid");
    const calendarLabel = document.getElementById("calendarLabel");
    const prevMonthBtn = document.getElementById("prevMonthBtn");
    const nextMonthBtn = document.getElementById("nextMonthBtn");
    const selectedDateLabel = document.getElementById("selectedDateLabel");
    const scheduledActions = document.getElementById("scheduledActions");
    const replaceBtn = document.getElementById("replaceBtn");
    const removeBtn = document.getElementById("removeBtn");

    let previewUrl = "";
    let scheduledDates = new Set();
    let scheduledPuzzles = new Map();
    let currentMonth = new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), 1));
    let selectedDateKey = "";
    let replaceTargetId = null;
    let replaceTargetKey = "";

    const weekdayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    function setStatus(el, msg, cls) {
      el.textContent = msg;
      el.className = `status ${cls || ""}`;
    }

    async function loadConfig() {
      const res = await fetch("/.netlify/functions/get-config");
      if (!res.ok) throw new Error("Missing Supabase config.");
      return res.json();
    }

    let supabaseClient;

    function showUploadUI() {
      uploadCard.style.display = "block";
      scheduleCard.style.display = "block";
    }

    function formatDateKey(date) {
      const y = date.getUTCFullYear();
      const m = String(date.getUTCMonth() + 1).padStart(2, "0");
      const d = String(date.getUTCDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function updateSelectedDateUI() {
      if (!selectedDateKey) {
        selectedDateLabel.textContent =
          "Select a date to set a publish date or manage scheduled puzzles.";
        scheduledActions.style.display = "none";
        return;
      }

      const scheduledPuzzle = scheduledPuzzles.get(selectedDateKey);
      if (scheduledPuzzle) {
        selectedDateLabel.textContent = `Selected ${selectedDateKey} (scheduled puzzle).`;
        scheduledActions.style.display = "flex";
      } else {
        selectedDateLabel.textContent = `Selected ${selectedDateKey} (open date).`;
        scheduledActions.style.display = "none";
      }
    }

    function selectDate(key) {
      selectedDateKey = key;
      if (key) {
        publishAtInput.value = key;
      }
      if (replaceTargetKey && replaceTargetKey !== key) {
        replaceTargetId = null;
        replaceTargetKey = "";
      }
      updateSelectedDateUI();
      renderCalendar();
    }

    function renderCalendar() {
      calendarGrid.innerHTML = "";
      const year = currentMonth.getUTCFullYear();
      const month = currentMonth.getUTCMonth();
      calendarLabel.textContent = currentMonth.toLocaleDateString("en-US", {
        month: "long",
        year: "numeric",
        timeZone: "UTC"
      });

      weekdayLabels.forEach((label) => {
        const cell = document.createElement("div");
        cell.textContent = label;
        cell.className = "calendar-weekday";
        calendarGrid.appendChild(cell);
      });

      const firstDay = new Date(Date.UTC(year, month, 1));
      const startOffset = firstDay.getUTCDay();
      const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
      const todayKey = formatDateKey(new Date());

      for (let i = 0; i < startOffset; i++) {
        const empty = document.createElement("div");
        empty.className = "calendar-day is-empty";
        calendarGrid.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(Date.UTC(year, month, day));
        const key = formatDateKey(date);
        const cell = document.createElement("div");
        const isScheduled = scheduledDates.has(key);
        cell.textContent = day;
        cell.className = `calendar-day ${isScheduled ? "is-scheduled" : "is-empty"}`;
        cell.setAttribute("role", "button");
        cell.setAttribute("tabindex", "0");
        cell.dataset.dateKey = key;
        if (key === selectedDateKey) {
          cell.classList.add("is-selected");
        }
        if (isScheduled) {
          cell.title = "Scheduled puzzle";
        }
        if (key === todayKey) {
          cell.classList.add("is-today");
        }
        cell.addEventListener("click", () => selectDate(key));
        cell.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            selectDate(key);
          }
        });
        calendarGrid.appendChild(cell);
      }
    }

    async function loadSchedule() {
      try {
        const { data } = await supabaseClient.auth.getSession();
        const token = data.session?.access_token;
        if (!token) {
          throw new Error("You are not authenticated.");
        }
        const res = await fetch("/.netlify/functions/list-puzzles-admin", {
          cache: "no-store",
          headers: {
            Authorization: `Bearer ${token}`
          }
        });
        if (res.status === 403) {
          throw new Error("Access denied. Contact the site owner.");
        }
        if (!res.ok) throw new Error("Unable to load puzzles");
        const data = await res.json();
        scheduledPuzzles = new Map();
        (data.puzzles || [])
          .filter((puzzle) => puzzle.publish_at)
          .forEach((puzzle) => {
            const key = formatDateKey(new Date(puzzle.publish_at));
            scheduledPuzzles.set(key, { id: puzzle.id, publishAt: puzzle.publish_at });
          });
        scheduledDates = new Set(Array.from(scheduledPuzzles.keys()));
        renderCalendar();
        updateSelectedDateUI();
      } catch (error) {
        calendarLabel.textContent = "Unable to load scheduled dates.";
      }
    }

    async function deletePuzzle(puzzleId) {
      const { data } = await supabaseClient.auth.getSession();
      const token = data.session?.access_token;
      if (!token) {
        throw new Error("You are not authenticated.");
      }
      const res = await fetch("/.netlify/functions/delete-puzzle", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ id: puzzleId })
      });
      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        throw new Error(errorData.error || "Delete failed.");
      }
    }

    async function init() {
      try {
        const { supabaseUrl, supabaseAnonKey } = await loadConfig();
        supabaseClient = window.supabase.createClient(
          supabaseUrl,
          supabaseAnonKey
        );
        const { data } = await supabaseClient.auth.getSession();
        if (data.session) {
          showUploadUI();
          setStatus(authStatus, "Authenticated.", "ok");
          await loadSchedule();
        }
      } catch (error) {
        setStatus(authStatus, "Unable to load Supabase config.", "bad");
      }
    }

    sendLinkBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      if (!email) {
        setStatus(authStatus, "Enter an email to send a magic link.", "bad");
        return;
      }
      setStatus(authStatus, "Sending magic link...", "");
      const emailRedirectTo = new URL("/admin.html", window.location.origin).toString();
      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo
        }
      });
      if (error) {
        setStatus(authStatus, error.message, "bad");
        return;
      }
      setStatus(authStatus, "Check your email for the sign-in link.", "ok");
    });

    logoutBtn.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      uploadCard.style.display = "none";
      scheduleCard.style.display = "none";
      setStatus(authStatus, "Signed out.", "");
    });

    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (!file) {
        imagePreview.removeAttribute("src");
        return;
      }
      if (previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl = URL.createObjectURL(file);
      imagePreview.src = previewUrl;
    });

    publishAtInput.addEventListener("change", () => {
      const key = publishAtInput.value;
      if (key && key !== selectedDateKey) {
        selectedDateKey = key;
        updateSelectedDateUI();
        renderCalendar();
      }
      if (replaceTargetKey && replaceTargetKey !== key) {
        replaceTargetId = null;
        replaceTargetKey = "";
      }
    });

    prevMonthBtn.addEventListener("click", () => {
      currentMonth = new Date(Date.UTC(currentMonth.getUTCFullYear(), currentMonth.getUTCMonth() - 1, 1));
      renderCalendar();
    });

    nextMonthBtn.addEventListener("click", () => {
      currentMonth = new Date(Date.UTC(currentMonth.getUTCFullYear(), currentMonth.getUTCMonth() + 1, 1));
      renderCalendar();
    });

    replaceBtn.addEventListener("click", () => {
      const scheduledPuzzle = scheduledPuzzles.get(selectedDateKey);
      if (!scheduledPuzzle) return;
      replaceTargetId = scheduledPuzzle.id;
      replaceTargetKey = selectedDateKey;
      publishAtInput.value = selectedDateKey;
      setStatus(
        uploadStatus,
        `Upload will replace the puzzle scheduled for ${selectedDateKey}.`,
        ""
      );
    });

    removeBtn.addEventListener("click", async () => {
      const scheduledPuzzle = scheduledPuzzles.get(selectedDateKey);
      if (!scheduledPuzzle) return;
      const confirmed = window.confirm(
        `Remove the puzzle scheduled for ${selectedDateKey}? This cannot be undone.`
      );
      if (!confirmed) return;
      setStatus(uploadStatus, "Removing scheduled puzzle...", "");
      try {
        await deletePuzzle(scheduledPuzzle.id);
        setStatus(uploadStatus, "Scheduled puzzle removed.", "ok");
        if (replaceTargetKey === selectedDateKey) {
          replaceTargetId = null;
          replaceTargetKey = "";
        }
        await loadSchedule();
      } catch (error) {
        setStatus(uploadStatus, error.message || "Remove failed.", "bad");
      }
    });

    uploadBtn.addEventListener("click", async () => {
      setStatus(uploadStatus, "", "");
      const image = document.getElementById("image").files[0];
      const publishAt = publishAtInput.value;
      const answer1a = document.getElementById("answer1a").value.trim();
      const answer1b = document.getElementById("answer1b").value.trim();
      const answer2a = document.getElementById("answer2a").value.trim();
      const answer2b = document.getElementById("answer2b").value.trim();
      const hints = document.getElementById("hints").value.trim();

      if (!image || !publishAt || !answer1a || !answer1b || !answer2a || !answer2b) {
        setStatus(uploadStatus, "Please complete all required fields.", "bad");
        return;
      }

      const { data } = await supabaseClient.auth.getSession();
      const token = data.session?.access_token;
      if (!token) {
        setStatus(uploadStatus, "You are not authenticated.", "bad");
        return;
      }

      const formData = new FormData();
      formData.append("image", image);
      formData.append("publish_at", `${publishAt}T00:00:00.000Z`);
      formData.append("answer_1a", answer1a);
      formData.append("answer_1b", answer1b);
      formData.append("answer_2a", answer2a);
      formData.append("answer_2b", answer2b);
      if (hints) {
        formData.append("hints", hints);
      }

      if (replaceTargetId && replaceTargetKey === publishAt) {
        setStatus(uploadStatus, "Removing existing puzzle...", "");
        try {
          await deletePuzzle(replaceTargetId);
        } catch (error) {
          setStatus(uploadStatus, error.message || "Replace failed.", "bad");
          return;
        }
      }

      setStatus(uploadStatus, "Uploading...", "");
      const res = await fetch("/.netlify/functions/upload-puzzle", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`
        },
        body: formData
      });

      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        setStatus(
          uploadStatus,
          errorData.error || "Upload failed.",
          "bad"
        );
        return;
      }

      const response = await res.json();
      setStatus(
        uploadStatus,
        `Uploaded! Image URL: ${response.image_url}`,
        "ok"
      );
      replaceTargetId = null;
      replaceTargetKey = "";
      await loadSchedule();
    });

    init();
  </script>
</body>
</html>
